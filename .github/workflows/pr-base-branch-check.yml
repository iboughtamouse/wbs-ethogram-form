name: PR Base Branch Check

on:
  pull_request:
    types: [opened, reopened, edited, synchronize]

jobs:
  check-base-branch:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write  # Required to comment on PRs
      issues: write         # PRs are issues in GitHub API
    
    steps:
      - name: Check PR base branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const baseBranch = pr.base.ref;
            const headBranch = pr.head.ref;
            
            console.log(`ðŸ“‹ Checking PR: ${headBranch} â†’ ${baseBranch}`);
            
            // Rule 1: staging â†’ main is allowed (releases)
            if (headBranch === 'staging' && baseBranch === 'main') {
              console.log('âœ… Release PR: staging â†’ main - allowed');
              return;
            }
            
            // Rule 2: docs/ branches can target main directly
            if (headBranch.startsWith('docs/') && baseBranch === 'main') {
              console.log('âœ… Documentation branch targeting main - allowed');
              return;
            }
            
            // Rule 3: Everything else should target staging
            if (baseBranch !== 'staging') {
              const commentMarker = '<!-- base-branch-check-bot -->';
              const commentBody = `${commentMarker}
              ## âš ï¸ Incorrect Base Branch
              
              This PR is targeting \`${baseBranch}\`, but our branching strategy requires all work to go through \`staging\` first.
              
              **Our branching workflow:**
              1. All feature work, fixes, and changes â†’ \`staging\` (integration & testing)
              2. When \`staging\` is stable â†’ \`main\` (production release)
              
              **Please update the base branch of this PR to \`staging\`.**
              
              **Exception:** If this is an emergency hotfix that must go directly to production, please:
              - Add the label \`hotfix\` to this PR
              - Document why this bypasses staging in the PR description
              
              See [CONTRIBUTING.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md) for more details.`;
              
              // Check for existing comment to avoid spam
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes(commentMarker)
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
                console.log('âœï¸ Updated existing comment');
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: commentBody
                });
                console.log('ðŸ’¬ Created new comment');
              }
              
              // Check if PR has 'hotfix' label (manual override)
              const hasHotfixLabel = pr.labels.some(label => label.name === 'hotfix');
              
              if (hasHotfixLabel) {
                console.log('ðŸš¨ Hotfix label detected - allowing direct merge to main');
                return;
              }
              
              core.setFailed(`PRs should target 'staging', not '${baseBranch}' (unless labeled as 'hotfix')`);
              return;
            }
            
            // Rule 4: Everything targeting staging is good!
            console.log(`âœ… PR targeting staging - approved`);
